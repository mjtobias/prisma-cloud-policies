{
  "policyUpi": "PC-GCP-GKE-366",
  "policyId": "3c2b1b56-a6d4-41c1-b306-4edc2c840c19",
  "policyType": "config",
  "cloudType": "gcp",
  "severity": "medium",
  "name": "GCP Kubernetes Engine Clusters have legacy compute engine metadata endpoints enabled",
  "description": "This policy identifies Google Kubernetes Engine (GKE) clusters that have legacy compute engine metadata endpoints enabled. Because GKE uses instance metadata to configure node VMs, some of this metadata is potentially sensitive and should be protected from workloads running on the cluster. Legacy metadata APIs expose the Compute Engine's instance metadata of server endpoints. As a best practice, disable legacy API and use v1 APIs to restrict a potential attacker from retrieving instance metadata.",
  "rule.criteria": "ea1503e1-6927-4416-ac45-b975571d96cb",
  "searchModel.query": "config from cloud.resource where cloud.type = 'gcp' AND api.name = 'gcloud-container-describe-clusters' AND json.rule = \"nodePools[*].config.metadata does not exist or nodePools[*].config.metadata does not contain disable-legacy-endpoints or nodePools[*].config.metadata.disable-legacy-endpoints does not contain true\"",
  "recommendation": "You can currently disable legacy metadata APIs only when creating a new cluster, or when adding a new node pool to an existing cluster. To fix this alert, create a new GKE cluster with legacy metadata APIs disabled, migrate all required data from the reported cluster to the newly created cluster before you delete the reported GKE cluster.\n\nTo create new Kubernetes engine cluster with private node feature enabled, perform the following:\n1. Login to GCP Portal\n2. Go to Kubernetes Engine (Left Panel)\n3. Select Kubernetes clusters \n4. Click on CREATE CLUSTER button\n5. Under the Node pools section, Click on the 'More node pool options' button\n6. On 'Edit node pool' window, For 'GCE instance metadata' click on 'Add metadata'\n7. Add 'disable-legacy-endpoints' as a metadata key and 'true' as a metadata value\n8. Click on 'Save'\n9. Click on 'Create'\n\nTo delete reported Kubernetes engine cluster, perform the following:\n1. Login to GCP Portal\n2. Go to Kubernetes Engine (Left Panel)\n3. Select Kubernetes clusters \n4. Click on reported Kubernetes cluster\n5. Click on the DELETE button\n6. On 'Delete a cluster' popup dialog, Click on DELETE to confirm the deletion of the cluster.",
  "remediable": false,
  "remediation.cliScriptTemplate": "",
  "remediation.description": "",
  "remediation.impact": "",
  "compliance.standard": [
    "CCPA 2018",
    "CIS v1.1.0 (GKE)",
    "MITRE ATT&CK [Beta]",
    "PIPEDA"
  ]
}